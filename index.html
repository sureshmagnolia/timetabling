<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timetable Architect V3.0 (Web Worker Edition)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes pulse-slow { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body class="bg-gray-50 text-slate-800 font-sans">
    <div id="root"></div>

    <script id="worker-script" type="javascript/worker">
        self.onmessage = function(e) {
            const { workload, classes, subjects, faculty, constraints, subjectLocks } = e.data;
            
            // --- WORKER UTILS ---
            const DAYS = 5; 
            const PERIODS = 5; 
            const schedule = {};
            const teacherBusy = {}; 
            const stats = { iterations: 0, backtracks: 0, teacherConflicts: 0, roomConflicts: 0, dailyLimit: 0, consecutiveLimit: 0, lockConflicts: 0 };
            
            // 1. Setup Data Structures
            faculty.forEach(f => teacherBusy[f.id] = Array(DAYS).fill(null).map(() => Array(PERIODS + 1).fill(false)));
            
            classes.forEach(cls => {
                schedule[cls.id] = Array(DAYS).fill(null).map(() => Array(PERIODS + 1).fill(null));
                if (cls.unavailable) {
                    cls.unavailable.forEach(slotStr => {
                        const [d, p] = slotStr.split('-').map(Number);
                        if (schedule[cls.id][d]) schedule[cls.id][d][p] = { type: 'BLOCKED' };
                    });
                }
            });

            // 2. Prepare Tasks
            const teacherLoad = {};
            workload.forEach(w => teacherLoad[w.teacherId] = (teacherLoad[w.teacherId] || 0) + (w.hoursPerWeek || 0));

            let tasks = [];
            workload.forEach(w => {
                const count = w.fixedDay ? 1 : w.hoursPerWeek;
                // We generate IDs here in worker for consistency
                for (let i = 0; i < count; i++) {
                    tasks.push({ ...w, uniqueId: Math.random().toString(36), isFixed: !!w.fixedDay });
                }
            });

            // Sort Heuristics
            tasks.sort((a, b) => {
                if (a.isFixed !== b.isFixed) return a.isFixed ? -1 : 1;
                const isALocked = subjectLocks[`${a.classId}-Any-Any`] === a.subjectId; 
                const isBLocked = subjectLocks[`${b.classId}-Any-Any`] === b.subjectId;
                if (isALocked !== isBLocked) return isALocked ? -1 : 1;
                return (teacherLoad[b.teacherId]||0) - (teacherLoad[a.teacherId]||0);
            });

            // Pre-calculate Slots
            const ALL_SLOTS = [];
            for(let d=0; d<DAYS; d++) for(let p=1; p<=PERIODS; p++) ALL_SLOTS.push({d, p});

            // --- VALIDATION LOGIC (Synchronous for speed) ---
            const isValid = (task, day, period) => {
                if (schedule[task.classId][day][period] !== null) { stats.roomConflicts++; return false; }
                if (teacherBusy[task.teacherId][day][period]) { stats.teacherConflicts++; return false; }
                if (task.assistantId && teacherBusy[task.assistantId][day][period]) { stats.teacherConflicts++; return false; }

                const lockKey = `${task.classId}-${day}-${period}`;
                const lockedSubjectId = subjectLocks[lockKey];
                if (lockedSubjectId && lockedSubjectId !== task.subjectId) { stats.lockConflicts++; return false; }

                if (!task.isFixed && !lockedSubjectId) {
                    let dailyCount = 0;
                    for(let p=1; p<=PERIODS; p++) if(teacherBusy[task.teacherId][day][p]) dailyCount++;
                    if (dailyCount >= constraints.maxDailyHours) { stats.dailyLimit++; return false; }

                    if (period > 1 && teacherBusy[task.teacherId][day][period-1]) {
                        if (teacherBusy[task.teacherId][day][period-1]) { // Simple consecutive check
                             // In tight loop, keep it simple: 
                             // If prev is busy, check prev-prev. 
                             if (period > 2 && teacherBusy[task.teacherId][day][period-2]) { 
                                 stats.consecutiveLimit++; return false; 
                             }
                        }
                    }
                }
                return true;
            };

            // --- SOLVER LOOP ---
            let lastUpdate = Date.now();
            const startTime = Date.now();

            const solve = (taskIndex) => {
                stats.iterations++;

                // Throttled UI Updates (Every 100ms)
                if ((stats.iterations & 127) === 0) { // Bitwise check is faster than modulo
                    const now = Date.now();
                    if (now - lastUpdate > 100) {
                        lastUpdate = now;
                        // Send progress back to Main Thread
                        const currentTaskName = subjects.find(s=>s.id === tasks[taskIndex]?.subjectId)?.name || "Finishing...";
                        self.postMessage({ 
                            type: 'progress', 
                            current: taskIndex, 
                            total: tasks.length, 
                            stats, 
                            elapsed: ((now - startTime)/1000).toFixed(1),
                            currentTaskName 
                        });
                    }
                }

                if (taskIndex >= tasks.length) return true;
                const task = tasks[taskIndex];

                const toggle = (d, p, val) => {
                    schedule[task.classId][d][p] = val ? task : null;
                    teacherBusy[task.teacherId][d][p] = val;
                    if(task.assistantId) teacherBusy[task.assistantId][d][p] = val;
                };

                // FIXED TASK
                if (task.isFixed) {
                    const d = parseInt(task.fixedDay);
                    const p = parseInt(task.fixedPeriod);
                    if (isValid(task, d, p)) {
                        toggle(d, p, true);
                        if (solve(taskIndex + 1)) return true;
                        toggle(d, p, false);
                    }
                    return false;
                }

                // FLEXIBLE TASK
                const forcedSlots = [];
                // Only scan locks if we have them
                const hasLocks = Object.keys(subjectLocks).length > 0;
                if(hasLocks) {
                    for(let d=0; d<DAYS; d++) for(let p=1; p<=PERIODS; p++) 
                        if (subjectLocks[`${task.classId}-${d}-${p}`] === task.subjectId) forcedSlots.push({d, p});
                }

                let slotsToTry = (forcedSlots.length > 0) ? forcedSlots.filter(s => schedule[task.classId][s.d][s.p] === null) : ALL_SLOTS;
                if(forcedSlots.length > 0 && slotsToTry.length === 0) return false;

                for (let i = 0; i < slotsToTry.length; i++) {
                    const {d, p} = slotsToTry[i];
                    if (isValid(task, d, p)) {
                        toggle(d, p, true);
                        if (solve(taskIndex + 1)) return true;
                        toggle(d, p, false);
                    } else {
                        stats.backtracks++;
                    }
                }
                return false;
            };

            // Start Solving (Synchronously - Fast!)
            try {
                const success = solve(0);
                self.postMessage({ type: 'done', success, schedule, stats });
            } catch (e) {
                self.postMessage({ type: 'error', message: e.message });
            }
        };
    </script>


    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { createRoot } = ReactDOM;
        const Icon = ({ name, className, onClick }) => <i data-lucide={name} className={className} onClick={onClick}></i>;

        // XML PARSER (Same as before)
        const parseXMLData = (xmlText) => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(xmlText, "text/xml");
            const faculty = Array.from(doc.getElementsByTagName('teacher')).map(t => ({ id: t.getAttribute('id'), name: t.getAttribute('name'), short: t.getAttribute('short'), color: t.getAttribute('color') || '#e0f2f1' }));
            const subjects = Array.from(doc.getElementsByTagName('subject')).map(s => ({ id: s.getAttribute('id'), name: s.getAttribute('name'), code: s.getAttribute('short') || s.getAttribute('name').substring(0, 5) }));
            const classes = Array.from(doc.getElementsByTagName('class')).map(c => ({ id: c.getAttribute('id'), name: c.getAttribute('name'), short: c.getAttribute('short'), unavailable: [] }));
            const workload = [];
            Array.from(doc.getElementsByTagName('lesson')).forEach(l => {
                const tIds = l.getAttribute('teacherids').split(',');
                const cIds = l.getAttribute('classids').split(',');
                const subId = l.getAttribute('subjectid');
                const periods = parseFloat(l.getAttribute('periodsperweek') || l.getAttribute('periodspercard') || 1);
                const primaryTeacher = tIds[0];
                const assistantTeacher = tIds.length > 1 ? tIds[1] : null;
                cIds.forEach(cId => {
                    if (!cId || !primaryTeacher) return;
                    workload.push({ id: l.getAttribute('id') + cId + Math.random().toString(36).substr(2, 5), classId: cId, subjectId: subId, teacherId: primaryTeacher, assistantId: assistantTeacher, hoursPerWeek: periods, type: assistantTeacher ? 'Joint' : 'Normal', isFixed: false });
                });
            });
            return { faculty, subjects, classes, workload };
        };

        const TimetableApp = () => {
            const [subjectLocks, setSubjectLocks] = useState({});
            const [activeTab, setActiveTab] = useState('faculty');
            const [isGenerating, setIsGenerating] = useState(false);
            const [generationError, setGenerationError] = useState(null);
            const [saveStatus, setSaveStatus] = useState('');
            const fileInputRef = useRef(null);
            const workerRef = useRef(null); // Reference to the Web Worker

            const [progress, setProgress] = useState({ current: 0, total: 0, stats: {}, elapsed: 0, currentTaskName: '' });

            const [faculty, setFaculty] = useState([{ id: '1', name: 'Suresh V', short: 'SV', color: '#ffebee' }]);
            const [classes, setClasses] = useState([{ id: '1', name: 'BSc Botany S6', short: 'S6', unavailable: [] }]);
            const [subjects, setSubjects] = useState([{ id: '1', name: 'Genetics', code: 'BOT101' }]);
            const [workload, setWorkload] = useState([]);
            const [constraints, setConstraints] = useState({ maxConsecutive: 2, maxDailyHours: 4, ensureAllDaysEngaged: true });
            const [finalSchedule, setFinalSchedule] = useState(null);

            // Init & Persistence
            useEffect(() => {
                const savedData = localStorage.getItem('timetable_builder_v7');
                if (savedData) {
                    try {
                        const parsed = JSON.parse(savedData);
                        if(parsed.faculty) setFaculty(parsed.faculty);
                        if(parsed.classes) setClasses(parsed.classes);
                        if(parsed.subjects) setSubjects(parsed.subjects);
                        if(parsed.workload) setWorkload(parsed.workload);
                        if(parsed.constraints) setConstraints(parsed.constraints);
                        if(parsed.subjectLocks) setSubjectLocks(parsed.subjectLocks);
                    } catch (e) { console.error(e); }
                }
                if(window.lucide) window.lucide.createIcons();
            }, []);

            useEffect(() => {
                const timeoutId = setTimeout(() => {
                    const data = { faculty, classes, subjects, workload, constraints, subjectLocks };
                    localStorage.setItem('timetable_builder_v7', JSON.stringify(data));
                    setSaveStatus('Saved');
                    setTimeout(() => setSaveStatus(''), 2000);
                }, 500);
                return () => clearTimeout(timeoutId);
            }, [faculty, classes, subjects, workload, constraints, subjectLocks]);

            useEffect(() => { if(window.lucide) window.lucide.createIcons(); });

            const checkPreConditions = () => {
                const errors = [];
                const teacherMap = {}; 
                workload.forEach(w => {
                    if (w.fixedDay !== undefined && w.fixedPeriod && w.fixedDay !== "") {
                        const key = `${w.teacherId}-${w.fixedDay}-${w.fixedPeriod}`;
                        const className = classes.find(c => c.id === w.classId)?.name;
                        if (teacherMap[key]) {
                            const tName = faculty.find(f => f.id === w.teacherId)?.name;
                            errors.push(`CONFLICT: ${tName} is double-booked in ${teacherMap[key]} and ${className} (Day ${parseInt(w.fixedDay)+1} P${w.fixedPeriod})`);
                        } else teacherMap[key] = className;
                    }
                });
                return errors;
            };

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const { faculty: f, subjects: s, classes: c, workload: w } = parseXMLData(evt.target.result);
                        setFaculty(f); setSubjects(s); setClasses(c); setWorkload(w);
                        alert(`Imported successfully!`);
                    } catch (err) { alert("Error parsing XML: " + err.message); }
                };
                reader.readAsText(file);
            };

            const handleGenerate = () => {
                const conflicts = checkPreConditions();
                if (conflicts.length > 0) {
                    alert("âŒ Please resolve conflicts in Workload tab first:\n" + conflicts.join("\n"));
                    return;
                }

                setIsGenerating(true);
                setGenerationError(null);
                setActiveTab('results');
                setProgress({ current: 0, total: 0, stats: {}, elapsed: 0, currentTaskName: 'Starting Worker...' });

                // 1. Create Web Worker from the script tag
                const blob = new Blob([document.getElementById('worker-script').textContent], { type: "text/javascript" });
                const worker = new Worker(URL.createObjectURL(blob));
                workerRef.current = worker;

                // 2. Setup Listeners
                worker.onmessage = (e) => {
                    const { type, current, total, stats, elapsed, currentTaskName, success, schedule, message } = e.data;
                    
                    if (type === 'progress') {
                        setProgress({ current, total, stats, elapsed, currentTaskName });
                    } else if (type === 'done') {
                        setFinalSchedule(schedule);
                        setIsGenerating(false);
                        worker.terminate();
                        if(!success) alert("Completed with partial results. Some classes could not be placed.");
                    } else if (type === 'error') {
                        setGenerationError(message);
                        setIsGenerating(false);
                        worker.terminate();
                    }
                };

                // 3. Start Worker
                worker.postMessage({ workload, classes, subjects, faculty, constraints, subjectLocks });
            };

            const handleStop = () => {
                if (workerRef.current) {
                    workerRef.current.terminate();
                    workerRef.current = null;
                }
                setIsGenerating(false);
                alert("Generation Stopped by User. (Previous results retained if any)");
            };

            const getFacultyLoad = (id) => workload.reduce((acc, w) => (w.teacherId === id || w.assistantId === id) ? acc + (w.hoursPerWeek||0) : acc, 0);

            // --- UI COMPONENTS ---
            
            const LoadingOverlay = () => (
                <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-lg p-6 max-w-lg w-full shadow-2xl">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-xl font-bold flex items-center gap-2">
                                <Icon name="cpu" className="animate-spin text-blue-600"/> Generating...
                            </h2>
                            <button onClick={handleStop} className="text-xs bg-red-100 text-red-600 px-3 py-1 rounded border border-red-200 hover:bg-red-200 font-bold">
                                STOP
                            </button>
                        </div>
                        <div className="w-full bg-gray-200 rounded-full h-4 mb-2 overflow-hidden">
                            <div className="bg-blue-600 h-4 rounded-full transition-all duration-300" style={{ width: `${(progress.current / (progress.total || 1)) * 100}%` }}></div>
                        </div>
                        <div className="flex justify-between text-xs text-gray-500 mb-6 font-mono">
                            <span>Placed: {progress.current} / {progress.total}</span>
                            <span>Time: {progress.elapsed}s</span>
                        </div>
                        <div className="bg-slate-900 rounded p-4 font-mono text-xs h-48 overflow-y-auto border border-slate-700 shadow-inner">
                            <div className="text-green-400 mb-1">$ worker_thread_active</div>
                            <div className="text-slate-400 mb-1">Loading {progress.total} tasks...</div>
                            {progress.currentTaskName && (<div className="text-yellow-300 mb-1 animate-pulse">> Processing: {progress.currentTaskName}</div>)}
                            <div className="mt-4 border-t border-slate-700 pt-2 grid grid-cols-2 gap-x-4">
                                <div className="text-blue-300 font-bold mb-1 col-span-2">--- LIVE METRICS ---</div>
                                <div className="text-red-400">Teacher Busy:</div><div className="text-right text-red-200">{progress.stats?.teacherConflicts || 0}</div>
                                <div className="text-red-400">Room Taken:</div><div className="text-right text-red-200">{progress.stats?.roomConflicts || 0}</div>
                                <div className="text-orange-400">Daily Limit:</div><div className="text-right text-orange-200">{progress.stats?.dailyLimit || 0}</div>
                                <div className="text-purple-400">Lock Clash:</div><div className="text-right text-purple-200">{progress.stats?.lockConflicts || 0}</div>
                                <div className="text-slate-500 mt-2 col-span-2 border-t border-slate-800 pt-1">Total Checks: {progress.stats?.iterations?.toLocaleString() || 0}</div>
                            </div>
                        </div>
                    </div>
                </div>
            );

            const FacultyTab = () => {
                const [form, setForm] = useState({ name: '', short: '' });
                const [editId, setEditId] = useState(null);
                const handleSubmit = () => {
                    if(!form.name) return;
                    if(editId) { setFaculty(faculty.map(f => f.id === editId ? { ...f, ...form } : f)); setEditId(null); } 
                    else { setFaculty([...faculty, { id: Date.now().toString(), ...form, color: '#f3f4f6' }]); }
                    setForm({ name: '', short: '' });
                };
                return (
                    <div className="space-y-6">
                        <div className="bg-white p-6 rounded shadow border">
                            <h3 className="font-bold mb-4 flex gap-2"><Icon name="users" /> {editId ? 'Edit' : 'Add'} Faculty</h3>
                            <div className="flex gap-2">
                                <input className="border p-2 rounded flex-1" placeholder="Name" value={form.name} onChange={e=>setForm({...form, name:e.target.value})} />
                                <input className="border p-2 rounded w-32" placeholder="Abbr" value={form.short} onChange={e=>setForm({...form, short:e.target.value})} />
                                <button onClick={handleSubmit} className={`${editId ? 'bg-orange-500' : 'bg-blue-600'} text-white px-4 rounded`}>{editId ? 'Update' : 'Add'}</button>
                                {editId && <button onClick={()=>{setEditId(null); setForm({name:'', short:''})}} className="text-gray-500">Cancel</button>}
                            </div>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            {faculty.map(f => {
                                const load = getFacultyLoad(f.id);
                                const badge = load > 16 ? 'bg-red-100 text-red-800' : load > 12 ? 'bg-orange-100 text-orange-800' : 'bg-green-100 text-green-800';
                                return (
                                    <div key={f.id} className={`p-4 rounded shadow border flex justify-between items-start bg-white ${editId===f.id?'ring-2 ring-orange-300':''}`}>
                                        <div><p className="font-bold">{f.name}</p><div className="flex gap-2 mt-1"><span className="text-xs bg-gray-100 px-2 rounded">{f.short}</span><span className={`text-xs px-2 rounded font-bold ${badge}`}>Load: {load}</span></div></div>
                                        <div className="flex gap-1"><button onClick={()=>{setEditId(f.id); setForm({name:f.name, short:f.short})}} className="text-gray-400 hover:text-blue-500"><Icon name="pencil" className="w-4 h-4"/></button><button onClick={()=>setFaculty(faculty.filter(x=>x.id!==f.id))} className="text-gray-400 hover:text-red-500"><Icon name="trash-2" className="w-4 h-4"/></button></div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                );
            };

            const EntitiesTab = () => {
                const [classForm, setClassForm] = useState({ name: '', short: '' });
                const [subForm, setSubForm] = useState({ name: '', code: '' });
                return (
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div className="space-y-4">
                            <div className="bg-white p-6 rounded shadow border">
                                <h3 className="font-bold mb-4 flex gap-2"><Icon name="graduation-cap" /> Classes</h3>
                                <div className="flex gap-2 mb-2"><input className="border p-2 rounded flex-1" placeholder="Class Name" value={classForm.name} onChange={e=>setClassForm({...classForm, name:e.target.value})} /><input className="border p-2 rounded w-24" placeholder="Short" value={classForm.short} onChange={e=>setClassForm({...classForm, short:e.target.value})} /><button onClick={()=>{if(classForm.name){setClasses([...classes, {id: Date.now().toString(), ...classForm, unavailable:[]}]); setClassForm({name:'', short:''})}}} className="bg-blue-600 text-white px-3 rounded">+</button></div>
                                <ul className="divide-y border rounded bg-gray-50">{classes.map(c=>(<li key={c.id} className="p-3 flex justify-between items-center"><span className="font-medium">{c.name}</span><button onClick={()=>setClasses(classes.filter(x=>x.id!==c.id))} className="text-red-500"><Icon name="trash-2" className="w-4 h-4"/></button></li>))}</ul>
                            </div>
                        </div>
                        <div className="space-y-4">
                            <div className="bg-white p-6 rounded shadow border">
                                <h3 className="font-bold mb-4 flex gap-2"><Icon name="book-open" /> Subjects</h3>
                                <div className="flex gap-2 mb-2"><input className="border p-2 rounded flex-1" placeholder="Subject Name" value={subForm.name} onChange={e=>setSubForm({...subForm, name:e.target.value})} /><input className="border p-2 rounded w-24" placeholder="Code" value={subForm.code} onChange={e=>setSubForm({...subForm, code:e.target.value})} /><button onClick={()=>{if(subForm.name){setSubjects([...subjects, {id: Date.now().toString(), ...subForm}]); setSubForm({name:'', code:''})}}} className="bg-blue-600 text-white px-3 rounded">+</button></div>
                                <ul className="divide-y border rounded bg-gray-50 max-h-64 overflow-auto">{subjects.map(s=>(<li key={s.id} className="p-3 flex justify-between"><span>{s.name}</span><button onClick={()=>setSubjects(subjects.filter(x=>x.id!==s.id))} className="text-red-500"><Icon name="trash-2" className="w-4 h-4"/></button></li>))}</ul>
                            </div>
                        </div>
                    </div>
                );
            };

            const WorkloadTab = () => {
                const [selClass, setSelClass] = useState(classes[0]?.id || '');
                const [form, setForm] = useState({ subId: '', teachId: '', asstId: '', hasAsst: false, hours: 1, isLocked: false, lDay: '0', lPer: '1' });
                const [editId, setEditId] = useState(null);
                const handleSubmit = () => {
                    if(!selClass || !form.subId || !form.teachId) return;
                    const payload = { classId: selClass, subjectId: form.subId, teacherId: form.teachId, assistantId: form.hasAsst ? form.asstId : null, hoursPerWeek: form.isLocked ? 1 : parseFloat(form.hours), type: form.hasAsst ? 'Joint' : 'Normal', fixedDay: form.isLocked ? form.lDay : undefined, fixedPeriod: form.isLocked ? form.lPer : undefined };
                    if(editId) { setWorkload(workload.map(w => w.id === editId ? { ...w, ...payload } : w)); setEditId(null); } else { setWorkload([...workload, { id: Date.now().toString(), ...payload }]); }
                    setForm({ ...form, isLocked: false, hours: 1 });
                };
                const startEdit = (w) => { setEditId(w.id); setSelClass(w.classId); setForm({ subId: w.subjectId, teachId: w.teacherId, asstId: w.assistantId||'', hasAsst: !!w.assistantId, hours: w.hoursPerWeek, isLocked: w.fixedDay!==undefined, lDay: w.fixedDay||'0', lPer: w.fixedPeriod||'1' }); };
                const cw = workload.filter(w => w.classId == selClass);
                const currentConflicts = checkPreConditions();

                return (
                    <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
                        <div className="lg:col-span-3 space-y-6">
                            <div className="bg-blue-50 p-4 rounded flex justify-between items-center">
                                <div className="flex gap-2 items-center">
                                    <span className="font-bold">Select Class:</span>
                                    <select className="border p-2 rounded w-48" value={selClass} onChange={e=>setSelClass(e.target.value)}>{classes.map(c=><option key={c.id} value={c.id}>{c.name}</option>)}</select>
                                </div>
                                <div className="font-mono bg-white px-2 rounded">Total: {cw.reduce((a,b)=>a+(b.hoursPerWeek||0),0)}</div>
                            </div>
                            <div className={`p-6 rounded shadow border grid grid-cols-1 md:grid-cols-4 gap-4 items-end ${editId?'bg-orange-50':''}`}>
                                <div><label className="text-xs font-bold block">Subject</label><select className="border p-2 w-full" value={form.subId} onChange={e=>setForm({...form, subId:e.target.value})}><option value="">Select</option>{subjects.map(s=><option key={s.id} value={s.id}>{s.name}</option>)}</select></div>
                                <div><label className="text-xs font-bold block">Teacher</label><select className="border p-2 w-full" value={form.teachId} onChange={e=>setForm({...form, teachId:e.target.value})}><option value="">Select</option>{faculty.map(f=><option key={f.id} value={f.id}>{f.name}</option>)}</select></div>
                                <div><div className="flex items-center gap-1"><input type="checkbox" checked={form.hasAsst} onChange={e=>setForm({...form, hasAsst:e.target.checked})}/><label className="text-xs font-bold">Assistant?</label></div><select className="border p-2 w-full" disabled={!form.hasAsst} value={form.asstId} onChange={e=>setForm({...form, asstId:e.target.value})}><option value="">None</option>{faculty.filter(f=>f.id!=form.teachId).map(f=><option key={f.id} value={f.id}>{f.name}</option>)}</select></div>
                                <div><label className="text-xs font-bold block">Hours</label><input type="number" disabled={form.isLocked} className="border p-2 w-full disabled:bg-gray-100" value={form.hours} onChange={e=>setForm({...form, hours:e.target.value})}/></div>
                                <div className="md:col-span-4 bg-yellow-50 p-3 rounded flex gap-4 items-center"><div className="flex gap-2 items-center"><input type="checkbox" checked={form.isLocked} onChange={e=>setForm({...form, isLocked:e.target.checked})}/><label className="text-sm font-bold">Lock Time?</label></div>{form.isLocked && <><select className="border p-1 rounded" value={form.lDay} onChange={e=>setForm({...form, lDay:e.target.value})}><option value="0">Mon</option><option value="1">Tue</option><option value="2">Wed</option><option value="3">Thu</option><option value="4">Fri</option></select><select className="border p-1 rounded" value={form.lPer} onChange={e=>setForm({...form, lPer:e.target.value})}>{[1,2,3,4,5].map(p=><option key={p} value={p}>P{p}</option>)}</select></>}</div>
                                <button onClick={handleSubmit} className="md:col-span-4 bg-green-600 text-white p-2 rounded">{editId?'Update':'Add'}</button>
                            </div>
                            <div className="bg-white rounded shadow border overflow-hidden"><table className="w-full text-left text-sm"><thead className="bg-gray-100 border-b"><tr><th className="p-3">Sub</th><th className="p-3">Fac</th><th className="p-3">Hrs</th><th></th></tr></thead><tbody>{cw.map(w => { const s=subjects.find(x=>x.id==w.subjectId); const t=faculty.find(x=>x.id==w.teacherId); return <tr key={w.id} className="border-b"><td className="p-3">{s?.name}</td><td className="p-3"><span className="bg-blue-100 px-2 py-1 rounded text-xs">{t?.short}</span>{w.assistantId && <span className="bg-cyan-100 px-2 py-1 rounded text-xs">+Asst</span>}</td><td className="p-3">{w.fixedDay ? <span className="bg-yellow-100 text-yellow-800 px-2 rounded text-xs">Locked</span> : w.hoursPerWeek}</td><td className="p-3 flex gap-1"><button onClick={()=>startEdit(w)} className="text-blue-500"><Icon name="pencil" className="w-4 h-4"/></button><button onClick={()=>setWorkload(workload.filter(x=>x.id!==w.id))} className="text-red-500"><Icon name="trash-2" className="w-4 h-4"/></button></td></tr>})}</tbody></table></div>
                        </div>
                        <div className="bg-white p-4 rounded shadow border h-fit max-h-screen overflow-y-auto sticky top-20">
                            <h3 className="font-bold border-b pb-2 mb-2 flex items-center gap-2"><Icon name="activity" className="w-4 h-4"/> System Status</h3>
                            {currentConflicts.length > 0 ? (
                                <div className="bg-red-50 border border-red-200 rounded p-2 mb-4"><div className="text-red-700 font-bold text-xs mb-1">Conflicts Detected:</div><ul className="text-xs text-red-600 list-disc pl-4 space-y-1">{currentConflicts.map((err, i) => <li key={i}>{err}</li>)}</ul></div>
                            ) : (<div className="bg-green-50 border border-green-200 rounded p-2 mb-4 text-xs text-green-700 font-bold text-center">No Conflicts Detected</div>)}
                            <h4 className="font-bold text-xs text-gray-500 uppercase mb-2">Faculty Load</h4>
                            <div className="space-y-2">{faculty.map(f => { const load = getFacultyLoad(f.id); const color = load > 20 ? 'bg-red-100 text-red-800' : load > 15 ? 'bg-orange-100 text-orange-800' : 'bg-gray-100 text-gray-600'; return (<div key={f.id} className="flex justify-between items-center text-sm border-b pb-1 last:border-0"><span className="truncate w-24" title={f.name}>{f.name}</span><span className={`px-2 py-0.5 rounded text-xs font-mono font-bold ${color}`}>{load} hrs</span></div>); })}</div>
                        </div>
                    </div>
                );
            };

            const ConstraintsTab = () => (
                <div className="bg-white p-6 rounded shadow border space-y-4">
                    <h3 className="font-bold flex gap-2"><Icon name="settings" /> Constraints</h3>
                    <div><label className="block text-sm font-bold">Max Consecutive</label><input type="number" className="border p-2 rounded w-full" value={constraints.maxConsecutive} onChange={e=>setConstraints({...constraints, maxConsecutive: parseInt(e.target.value)})}/></div>
                    <div><label className="block text-sm font-bold">Max Daily</label><input type="number" className="border p-2 rounded w-full" value={constraints.maxDailyHours} onChange={e=>setConstraints({...constraints, maxDailyHours: parseInt(e.target.value)})}/></div>
                    <div className="flex gap-2"><input type="checkbox" checked={constraints.ensureAllDaysEngaged} onChange={e=>setConstraints({...constraints, ensureAllDaysEngaged:e.target.checked})}/><label className="font-bold text-sm">Ensure Daily Engagement</label></div>
                </div>
            );

            const ResultsTab = () => {
                const [selectedSlot, setSelectedSlot] = useState(null); 

                const handleAllocation = (type, id) => {
                    const { clsId, day, period } = selectedSlot;
                    if (type === 'SUBJECT_LOCK') {
                        const key = `${clsId}-${day}-${period}`;
                        const newLocks = { ...subjectLocks };
                        if (newLocks[key] === id) delete newLocks[key]; 
                        else newLocks[key] = id;
                        setSubjectLocks(newLocks);
                    } 
                    else if (type === 'MANUAL_TASK') {
                        const newWorkload = workload.map(w => w.id === id ? { ...w, fixedDay: day.toString(), fixedPeriod: period.toString() } : w);
                        setWorkload(newWorkload);
                    }
                    else if (type === 'BLOCK_SLOT') {
                        const key = `${day}-${period}`;
                        const newClasses = classes.map(c => {
                            if (c.id !== clsId) return c;
                            const isBlocked = c.unavailable.includes(key);
                            return { ...c, unavailable: isBlocked ? c.unavailable.filter(k => k !== key) : [...c.unavailable, key] };
                        });
                        setClasses(newClasses);
                    }
                    setSelectedSlot(null);
                };

                const AllocationModal = () => {
                    if (!selectedSlot) return null;
                    const { clsId, day, period } = selectedSlot;
                    const clsWorkload = workload.filter(w => w.classId === clsId);
                    const currentLock = subjectLocks[`${clsId}-${day}-${period}`];
                    const cls = classes.find(c => c.id === clsId);
                    const isBlocked = cls.unavailable.includes(`${day}-${period}`);
                    const className = cls?.name;

                    return (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 sm:p-6" onClick={()=>setSelectedSlot(null)}>
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] flex flex-col overflow-hidden" onClick={e=>e.stopPropagation()}>
                                <div className="bg-slate-50 p-4 border-b flex justify-between items-center shrink-0">
                                    <div><h3 className="font-bold text-lg text-slate-800">{className}</h3><div className="text-xs text-slate-500 font-mono">Day {["Mon","Tue","Wed","Thu","Fri"][day]} â€¢ Period {period}</div></div>
                                    <button onClick={()=>setSelectedSlot(null)} className="text-gray-400 hover:text-red-500"><Icon name="x"/></button>
                                </div>
                                <div className="p-4 overflow-y-auto flex-1 space-y-6 bg-white">
                                    <div>
                                        <h4 className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-3">Option A: Lock Subject (Flexible Teacher)</h4>
                                        <div className="grid grid-cols-2 gap-2">
                                            {subjects.map(s => (
                                                <button key={s.id} onClick={() => handleAllocation('SUBJECT_LOCK', s.id)} disabled={isBlocked}
                                                    className={`p-2 rounded text-sm border transition-all ${currentLock === s.id ? 'bg-purple-600 text-white border-purple-600' : 'bg-slate-50 border-slate-200 text-slate-600 hover:border-purple-300'} disabled:opacity-50`}>
                                                    <div className="font-bold truncate">{s.name}</div>{currentLock === s.id && <div className="text-[10px] opacity-75">Active Lock</div>}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                    <div>
                                        <h4 className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-3">Option B: Force Specific Teacher</h4>
                                        <div className="space-y-2">
                                            {clsWorkload.map(w => {
                                                const sub = subjects.find(s=>s.id==w.subjectId);
                                                const tea = faculty.find(f=>f.id==w.teacherId);
                                                const isPlacedHere = w.fixedDay == day && w.fixedPeriod == period;
                                                return (
                                                    <button key={w.id} onClick={() => handleAllocation('MANUAL_TASK', w.id)} disabled={isBlocked}
                                                        className={`w-full text-left p-3 rounded-lg border flex items-center justify-between group transition-all ${isPlacedHere ? 'bg-green-50 border-green-500 ring-1 ring-green-500' : 'bg-white border-slate-200 hover:border-blue-400'} disabled:opacity-50`}>
                                                        <div><div className="font-bold text-sm text-slate-800">{sub?.name}</div><div className="text-xs text-slate-500 flex items-center gap-1"><Icon name="user" className="w-3 h-3"/> {tea?.name}</div></div>
                                                        {isPlacedHere ? <Icon name="check-circle" className="w-5 h-5 text-green-600"/> : <div className="text-xs bg-slate-100 text-slate-500 px-2 py-1 rounded group-hover:bg-blue-600 group-hover:text-white transition-colors">Assign</div>}
                                                    </button>
                                                )
                                            })}
                                        </div>
                                    </div>
                                    <div className="pt-4 border-t">
                                        <h4 className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-3">Option C: Availability</h4>
                                        <button onClick={() => handleAllocation('BLOCK_SLOT')} className={`w-full py-3 rounded-lg font-bold text-sm flex items-center justify-center gap-2 ${isBlocked ? 'bg-green-100 text-green-700 hover:bg-green-200' : 'bg-red-100 text-red-700 hover:bg-red-200'}`}>
                                            {isBlocked ? <><Icon name="unlock" className="w-4 h-4"/> Unblock Slot (Make Available)</> : <><Icon name="lock" className="w-4 h-4"/> Block Slot (Make Unavailable)</>}
                                        </button>
                                    </div>
                                </div>
                                <div className="p-4 border-t bg-slate-50 shrink-0"><button className="w-full py-3 bg-white border border-slate-300 rounded-lg text-slate-600 font-bold text-sm hover:bg-slate-100" onClick={()=>setSelectedSlot(null)}>Cancel</button></div>
                            </div>
                        </div>
                    );
                };

                if(generationError) return <div className="bg-red-50 p-8 text-center text-red-600 rounded">Error: {generationError} <br/><button onClick={()=>setActiveTab('workload')} className="text-blue-600 underline">Back</button></div>;
                
                const activeSchedule = finalSchedule || classes.reduce((acc, cls) => {
                    acc[cls.id] = Array(5).fill(null).map(() => Array(6).fill(null));
                    return acc;
                }, {});

                return (
                    <div className="space-y-8 relative">
                        {selectedSlot && <AllocationModal />}
                        {finalSchedule && (
                            <div className="flex justify-end sticky top-16 z-20"><button onClick={handleGenerate} className="bg-purple-600 text-white px-4 py-2 rounded shadow flex gap-2 items-center hover:bg-purple-700"><Icon name="refresh-cw" className="w-4 h-4"/> Resume / Regenerate</button></div>
                        )}
                        {classes.map(cls => (
                            <div key={cls.id} className="bg-white rounded shadow border overflow-hidden">
                                <div className="bg-gray-100 p-3 font-bold border-b flex justify-between">{cls.name}<span className="text-xs font-normal text-gray-500">Click cells to edit</span></div>
                                <div className="overflow-x-auto"><table className="w-full text-center text-sm border-collapse table-fixed">
                                    <thead><tr><th className="border p-2 w-16">Day</th>{[1,2,3,4,5].map(p=><th key={p} className="border p-2">P{p}</th>)}</tr></thead>
                                    <tbody>{["M","T","W","T","F"].map((d,i)=><tr key={i}><td className="border p-2 font-bold bg-gray-50">{d}</td>{[1,2,3,4,5].map(p=>{
                                        const slot = activeSchedule[cls.id][i][p];
                                        const lockId = subjectLocks[`${cls.id}-${i}-${p}`];
                                        const lockedSub = lockId ? subjects.find(s=>s.id===lockId) : null;
                                        let cellContent = <span className="text-gray-300">-</span>;
                                        let cellClass = "hover:bg-blue-50 cursor-pointer transition-colors";

                                        if(slot && slot.type==='BLOCKED') { cellContent = "N/A"; cellClass = "bg-red-50 text-red-300"; } 
                                        else if (slot) {
                                            const s=subjects.find(x=>x.id==slot.subjectId); const t=faculty.find(x=>x.id==slot.teacherId);
                                            cellContent = <><div className="font-bold">{s?.code||s?.name}</div><div className="text-xs"><span style={{background:t?.color}} className="px-1 rounded border">{t?.short}</span></div>{slot.isFixed && <div className="text-[10px] text-green-600">Fixed</div>}</>;
                                            if(slot.isFixed) cellClass += " bg-green-50";
                                        } else if (lockedSub) {
                                            cellContent = <div className="text-purple-600 font-bold text-xs">ðŸ”’ {lockedSub.name}</div>;
                                            cellClass += " bg-purple-50 ring-2 ring-inset ring-purple-200";
                                        }
                                        return <td key={p} className={`border p-2 h-16 ${cellClass}`} onClick={() => setSelectedSlot({clsId: cls.id, day: i, period: p})}>{cellContent}</td>;
                                    })}</tr>)}</tbody>
                                </table></div>
                            </div>
                        ))}
                    </div>
                );
            };

            return (
                <div className="min-h-screen pb-20">
                    <div className="bg-white border-b sticky top-0 z-10 px-4 h-16 flex items-center justify-between shadow-sm">
                        <h1 className="font-bold text-xl flex items-center gap-2"><Icon name="calendar" /> Timetable Architect 3.0</h1>
                        <div className="flex gap-4 items-center">
                            <span className={`text-xs font-bold text-green-600 transition-opacity ${saveStatus?'opacity-100':'opacity-0'}`}>Saved</span>
                            <div className="relative overflow-hidden"><button className="text-xs bg-slate-100 px-3 py-1 rounded hover:bg-slate-200 border flex gap-1 items-center"><Icon name="upload" className="w-3 h-3"/> Import XML</button><input type="file" ref={fileInputRef} onChange={handleFileUpload} className="absolute inset-0 opacity-0 cursor-pointer" accept=".xml"/></div>
                        </div>
                    </div>
                    {isGenerating && <LoadingOverlay />}
                    <div className="px-4 mt-2 overflow-x-auto"><div className="flex space-x-1 border-b">{['faculty','entities','workload','constraints','results'].map(t=><button key={t} onClick={()=>setActiveTab(t)} className={`px-4 py-2 capitalize border-b-2 ${activeTab===t?'border-blue-600 text-blue-600':'border-transparent text-gray-500'}`}>{t==='entities'?'Classes':t}</button>)}</div></div>
                    <div className="max-w-6xl mx-auto p-4">{activeTab==='faculty'&&<FacultyTab/>}{activeTab==='entities'&&<EntitiesTab/>}{activeTab==='workload'&&<WorkloadTab/>}{activeTab==='constraints'&&<ConstraintsTab/>}{activeTab==='results'&&<ResultsTab/>}</div>
                    {activeTab!=='results' && <button onClick={handleGenerate} className="fixed bottom-8 right-8 bg-blue-600 text-white px-6 py-3 rounded-full shadow-lg font-bold flex gap-2"><Icon name="play"/> Generate</button>}
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<TimetableApp />);
    </script>
</body>
</html>
