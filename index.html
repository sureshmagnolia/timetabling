<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timetable Architect</title>
    
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Load React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- 3. Load Babel (To translate JSX in the browser) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 4. Load Icons (Lucide) -->
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-gray-50 text-slate-800">
    <div id="root"></div>

    <!-- MAIN SCRIPT -->
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { createRoot } = ReactDOM;
        
        // --- ICONS WRAPPER ---
        const Icon = ({ name, className, onClick }) => <i data-lucide={name} className={className} onClick={onClick}></i>;

        // --- LOGIC ENGINE (Backtracking Algorithm) ---
        const generateId = () => Math.floor(Math.random() * 100000);

        const runBacktrackingAlgorithm = (workload, classes, subjects, faculty, constraints) => {
            const DAYS = 5; 
            const PERIODS = 5; 
            
            const schedule = {}; 
            classes.forEach(cls => {
                schedule[cls.id] = Array(DAYS).fill(null).map(() => Array(PERIODS + 1).fill(null)); 
            });

            let tasks = [];
            workload.forEach(w => {
                for (let i = 0; i < w.hoursPerWeek; i++) {
                    tasks.push({ ...w, uniqueId: generateId() });
                }
            });

            // Sort: Joint classes first, then by total load desc
            tasks.sort((a, b) => {
                if (a.type === 'Joint' && b.type !== 'Joint') return -1;
                return 0;
            });

            const isValid = (task, day, period, currentSchedule) => {
                // 1. Room Check
                if (currentSchedule[task.classId][day][period] !== null) return false;

                // 2. Teacher Conflict Check
                for (const cls of classes) {
                    const slot = currentSchedule[cls.id][day][period];
                    if (slot) {
                        // Conflict with Primary Teacher
                        if (slot.teacherId === task.teacherId || slot.assistantId === task.teacherId) return false;
                        // Conflict with Assistant Teacher
                        if (task.assistantId) {
                            if (slot.teacherId === task.assistantId || slot.assistantId === task.assistantId) return false;
                        }
                        // Edge case: Current slot's assistant is our primary
                        if (slot.assistantId === task.teacherId) return false;
                    }
                }

                // 3. Constraint: Max Consecutive Hours
                if (constraints.maxConsecutive) {
                    let consecutiveCount = 0;
                    for (let p = period - 1; p >= 1; p--) {
                        let isBusy = false;
                        for (const cls of classes) {
                            const slot = currentSchedule[cls.id][day][p];
                            if (slot && (slot.teacherId === task.teacherId || slot.assistantId === task.teacherId)) {
                                isBusy = true;
                                break;
                            }
                        }
                        if (isBusy) consecutiveCount++;
                        else break; 
                    }
                    if (consecutiveCount >= constraints.maxConsecutive) return false;
                }

                // 4. Constraint: Max Daily Hours
                if (constraints.maxDailyHours) {
                    let dailyCount = 0;
                    for(let p = 1; p <= PERIODS; p++) {
                        for(const cls of classes) {
                            const slot = currentSchedule[cls.id][day][p];
                            if(slot && (slot.teacherId === task.teacherId || slot.assistantId === task.teacherId)) {
                                dailyCount++;
                            }
                        }
                    }
                    if (dailyCount >= constraints.maxDailyHours) return false;
                }

                return true;
            };

            const solve = (taskIndex) => {
                if (taskIndex >= tasks.length) return true;
                const task = tasks[taskIndex];
                
                for (let day = 0; day < DAYS; day++) {
                    for (let period = 1; period <= PERIODS; period++) {
                        if (isValid(task, day, period, schedule)) {
                            schedule[task.classId][day][period] = task;
                            if (solve(taskIndex + 1)) return true;
                            schedule[task.classId][day][period] = null;
                        }
                    }
                }
                return false;
            };

            if (solve(0)) return schedule;
            throw new Error("Conflict found! Could not generate timetable. Try relaxing constraints or reducing workload.");
        };

        // --- MAIN APP COMPONENT ---
        const TimetableApp = () => {
            const [activeTab, setActiveTab] = useState('faculty');
            const [isGenerating, setIsGenerating] = useState(false);
            const [generationError, setGenerationError] = useState(null);
            const [saveStatus, setSaveStatus] = useState('');
            
            // --- DATA STATE ---
            const [faculty, setFaculty] = useState([
                { id: 1, name: 'Suresh V', short: 'SV', color: '#ffebee' },
                { id: 2, name: 'Sojan Jose', short: 'SJ', color: '#e0f7ff' }
            ]);
            const [classes, setClasses] = useState([
                { id: 1, name: 'BSc Botany S6', short: 'S6' }
            ]);
            const [subjects, setSubjects] = useState([
                { id: 1, name: 'Genetics', code: 'BOT101' }
            ]);
            const [workload, setWorkload] = useState([]);
            const [constraints, setConstraints] = useState({
                maxConsecutive: 2,
                maxDailyHours: 4
            });
            const [finalSchedule, setFinalSchedule] = useState(null);

            // --- LOAD INITIAL DATA ---
            useEffect(() => {
                const savedData = localStorage.getItem('timetable_builder_data');
                if (savedData) {
                    try {
                        const parsed = JSON.parse(savedData);
                        if(parsed.faculty) setFaculty(parsed.faculty);
                        if(parsed.classes) setClasses(parsed.classes);
                        if(parsed.subjects) setSubjects(parsed.subjects);
                        if(parsed.workload) setWorkload(parsed.workload);
                        if(parsed.constraints) setConstraints(parsed.constraints);
                    } catch (e) { console.error(e); }
                }
                if(window.lucide) window.lucide.createIcons();
            }, []);

            // --- AUTO SAVE ---
            useEffect(() => {
                const timeoutId = setTimeout(() => {
                    const data = { faculty, classes, subjects, workload, constraints };
                    localStorage.setItem('timetable_builder_data', JSON.stringify(data));
                    setSaveStatus('Saved');
                    setTimeout(() => setSaveStatus(''), 2000);
                }, 500);
                return () => clearTimeout(timeoutId);
            }, [faculty, classes, subjects, workload, constraints]);

            // Re-render icons on updates
            useEffect(() => {
                if(window.lucide) window.lucide.createIcons();
            });

            const handleGenerate = () => {
                setIsGenerating(true);
                setGenerationError(null);
                setActiveTab('results');
                
                setTimeout(() => {
                    try {
                        const result = runBacktrackingAlgorithm(workload, classes, subjects, faculty, constraints);
                        setFinalSchedule(result);
                    } catch (err) {
                        setGenerationError(err.message);
                    } finally {
                        setIsGenerating(false);
                    }
                }, 100);
            };

            // --- SUB-COMPONENTS ---

            const FacultyTab = () => {
                const [form, setForm] = useState({ name: '', short: '' });
                const [editId, setEditId] = useState(null);

                const handleSubmit = () => {
                    if(!form.name) return;
                    if (editId) {
                        setFaculty(faculty.map(f => f.id === editId ? { ...f, ...form } : f));
                        setEditId(null);
                    } else {
                        setFaculty([...faculty, { id: Date.now(), ...form, color: '#f3f4f6' }]);
                    }
                    setForm({ name: '', short: '' });
                };

                const startEdit = (f) => {
                    setForm({ name: f.name, short: f.short });
                    setEditId(f.id);
                };

                return (
                    <div className="space-y-6">
                        <div className="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                            <h3 className="font-bold mb-4 flex items-center gap-2 text-blue-800">
                                <Icon name={editId ? "pencil" : "plus"} className="w-5 h-5" /> 
                                {editId ? "Edit Faculty" : "Add Faculty"}
                            </h3>
                            <div className="flex flex-col md:flex-row gap-2">
                                <input className="border p-2 rounded flex-1 focus:ring-2 focus:ring-blue-200 outline-none" placeholder="Full Name" value={form.name} onChange={e=>setForm({...form, name:e.target.value})} />
                                <input className="border p-2 rounded w-full md:w-32 focus:ring-2 focus:ring-blue-200 outline-none" placeholder="Abbr (SV)" value={form.short} onChange={e=>setForm({...form, short:e.target.value})} />
                                <div className="flex gap-2">
                                    <button onClick={handleSubmit} className={`${editId ? 'bg-orange-500 hover:bg-orange-600' : 'bg-blue-600 hover:bg-blue-700'} text-white px-6 rounded font-medium transition-colors`}>
                                        {editId ? "Update" : "Add"}
                                    </button>
                                    {editId && <button onClick={() => {setEditId(null); setForm({name:'', short:''})}} className="text-gray-500 hover:bg-gray-100 px-3 rounded">Cancel</button>}
                                </div>
                            </div>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {faculty.map(f => (
                                <div key={f.id} className={`p-4 rounded-lg shadow-sm border flex justify-between items-center transition-all ${editId === f.id ? 'ring-2 ring-orange-400 bg-orange-50' : 'bg-white hover:shadow-md'}`}>
                                    <div>
                                        <p className="font-bold text-gray-800">{f.name}</p>
                                        <span className="text-xs bg-blue-50 text-blue-700 border border-blue-100 px-2 py-1 rounded mt-1 inline-block">{f.short}</span>
                                    </div>
                                    <div className="flex gap-1">
                                        <button onClick={()=>startEdit(f)} className="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded"><Icon name="pencil" className="w-4 h-4" /></button>
                                        <button onClick={()=>setFaculty(faculty.filter(x=>x.id!==f.id))} className="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded"><Icon name="trash-2" className="w-4 h-4" /></button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            };

            const EntitiesTab = () => {
                const [classForm, setClassForm] = useState({ name: '', short: '' });
                const [editClassId, setEditClassId] = useState(null);
                const [subForm, setSubForm] = useState({ name: '', code: '' });
                const [editSubId, setEditSubId] = useState(null);

                const handleClassSubmit = () => {
                    if(!classForm.name) return;
                    if(editClassId) {
                        setClasses(classes.map(c => c.id === editClassId ? {...c, ...classForm} : c));
                        setEditClassId(null);
                    } else {
                        setClasses([...classes, {id: Date.now(), ...classForm}]);
                    }
                    setClassForm({name:'', short:''});
                };

                const handleSubSubmit = () => {
                    if(!subForm.name) return;
                    if(editSubId) {
                        setSubjects(subjects.map(s => s.id === editSubId ? {...s, ...subForm} : s));
                        setEditSubId(null);
                    } else {
                        setSubjects([...subjects, {id: Date.now(), ...subForm}]);
                    }
                    setSubForm({name:'', code:''});
                };

                return (
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div className="space-y-4">
                            <div className="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                                <h3 className="font-bold mb-4 flex items-center gap-2 text-blue-800"><Icon name="graduation-cap" className="w-5 h-5"/> Classes</h3>
                                <div className="flex gap-2 mb-2">
                                    <input className="border p-2 rounded flex-1 focus:ring-2 focus:ring-blue-100 outline-none" placeholder="Class Name" value={classForm.name} onChange={e=>setClassForm({...classForm, name:e.target.value})} />
                                    <input className="border p-2 rounded w-24 focus:ring-2 focus:ring-blue-100 outline-none" placeholder="Short" value={classForm.short} onChange={e=>setClassForm({...classForm, short:e.target.value})} />
                                    <button onClick={handleClassSubmit} className={`px-4 rounded text-white ${editClassId ? 'bg-orange-500' : 'bg-blue-600'}`}>{editClassId ? <Icon name="check" className="w-4 h-4" /> : <Icon name="plus" className="w-4 h-4" />}</button>
                                </div>
                                {editClassId && <button onClick={()=>{setEditClassId(null); setClassForm({name:'', short:''})}} className="text-xs text-gray-500 underline mb-2">Cancel Edit</button>}
                                <ul className="divide-y border rounded bg-gray-50">
                                    {classes.map(c=>(
                                        <li key={c.id} className={`p-3 flex justify-between items-center ${editClassId===c.id ? 'bg-orange-50' : ''}`}>
                                            <span className="font-medium">{c.name} <span className="text-gray-400 font-normal">({c.short})</span></span>
                                            <div className="flex gap-1">
                                                <button onClick={()=>{setEditClassId(c.id); setClassForm({name:c.name, short:c.short})}} className="text-gray-400 hover:text-blue-600 p-1"><Icon name="pencil" className="w-4 h-4"/></button>
                                                <button onClick={()=>setClasses(classes.filter(x=>x.id!==c.id))} className="text-gray-400 hover:text-red-500 p-1"><Icon name="trash-2" className="w-4 h-4"/></button>
                                            </div>
                                        </li>
                                    ))}
                                </ul>
                            </div>
                        </div>
                        <div className="space-y-4">
                            <div className="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                                <h3 className="font-bold mb-4 flex items-center gap-2 text-blue-800"><Icon name="book-open" className="w-5 h-5"/> Subjects</h3>
                                <div className="flex gap-2 mb-2">
                                    <input className="border p-2 rounded flex-1 focus:ring-2 focus:ring-blue-100 outline-none" placeholder="Subject Name" value={subForm.name} onChange={e=>setSubForm({...subForm, name:e.target.value})} />
                                    <input className="border p-2 rounded w-24 focus:ring-2 focus:ring-blue-100 outline-none" placeholder="Code" value={subForm.code} onChange={e=>setSubForm({...subForm, code:e.target.value})} />
                                    <button onClick={handleSubSubmit} className={`px-4 rounded text-white ${editSubId ? 'bg-orange-500' : 'bg-blue-600'}`}>{editSubId ? <Icon name="check" className="w-4 h-4" /> : <Icon name="plus" className="w-4 h-4" />}</button>
                                </div>
                                {editSubId && <button onClick={()=>{setEditSubId(null); setSubForm({name:'', code:''})}} className="text-xs text-gray-500 underline mb-2">Cancel Edit</button>}
                                <ul className="divide-y border rounded bg-gray-50 max-h-96 overflow-y-auto">
                                    {subjects.map(s=>(
                                        <li key={s.id} className={`p-3 flex justify-between items-center ${editSubId===s.id ? 'bg-orange-50' : ''}`}>
                                            <span className="font-medium">{s.name} <span className="text-gray-400 font-normal">({s.code})</span></span>
                                            <div className="flex gap-1">
                                                <button onClick={()=>{setEditSubId(s.id); setSubForm({name:s.name, code:s.code})}} className="text-gray-400 hover:text-blue-600 p-1"><Icon name="pencil" className="w-4 h-4"/></button>
                                                <button onClick={()=>setSubjects(subjects.filter(x=>x.id!==s.id))} className="text-gray-400 hover:text-red-500 p-1"><Icon name="trash-2" className="w-4 h-4"/></button>
                                            </div>
                                        </li>
                                    ))}
                                </ul>
                            </div>
                        </div>
                    </div>
                );
            };

            const WorkloadTab = () => {
                const [selClass, setSelClass] = useState(classes[0]?.id || '');
                const [form, setForm] = useState({ subId: '', teachId: '', asstId: '', hasAsst: false, hours: 1 });
                const [editId, setEditId] = useState(null);
                
                const handleSubmit = () => {
                    if(!selClass || !form.subId || !form.teachId) return;
                    
                    const payload = {
                        classId: parseInt(selClass),
                        subjectId: parseInt(form.subId),
                        teacherId: parseInt(form.teachId),
                        assistantId: form.hasAsst ? parseInt(form.asstId) : null,
                        hoursPerWeek: parseInt(form.hours),
                        type: form.hasAsst ? 'Joint' : 'Normal'
                    };

                    if (editId) {
                        setWorkload(workload.map(w => w.id === editId ? { ...w, ...payload } : w));
                        setEditId(null);
                    } else {
                        setWorkload([...workload, { id: Date.now(), ...payload }]);
                    }
                    setForm({ ...form, subId: '', hours: 1 }); 
                };

                const startEdit = (w) => {
                    setEditId(w.id);
                    setSelClass(w.classId);
                    setForm({
                        subId: w.subjectId,
                        teachId: w.teacherId,
                        asstId: w.assistantId || '',
                        hasAsst: !!w.assistantId,
                        hours: w.hoursPerWeek
                    });
                };

                const classWork = workload.filter(w => w.classId == selClass);
                
                return (
                    <div className="space-y-6">
                        <div className="bg-blue-50 p-4 rounded-lg border border-blue-100 flex flex-col md:flex-row justify-between items-center gap-4">
                            <div className="flex gap-2 items-center w-full md:w-auto">
                                <span className="font-bold text-blue-800 whitespace-nowrap">Select Class:</span>
                                <select className="border p-2 rounded w-full md:w-64" value={selClass} onChange={e=>setSelClass(e.target.value)}>
                                    {classes.map(c=><option key={c.id} value={c.id}>{c.name}</option>)}
                                </select>
                            </div>
                            <div className="font-mono text-blue-800 bg-white px-3 py-1 rounded border">
                                Total Load: <strong>{classWork.reduce((a,b)=>a+b.hoursPerWeek, 0)}</strong> / 25
                            </div>
                        </div>

                        <div className={`p-6 rounded-lg shadow-sm border transition-colors ${editId ? 'bg-orange-50 border-orange-200' : 'bg-white border-gray-200'}`}>
                            <h4 className={`text-sm font-bold uppercase mb-4 tracking-wide ${editId ? 'text-orange-700' : 'text-gray-500'}`}>
                                {editId ? "Editing Entry..." : "Assign New Workload"}
                            </h4>
                            <div className="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                                <div className="md:col-span-3">
                                    <label className="text-xs font-bold text-gray-500 block mb-1">Subject</label>
                                    <select className="border p-2 rounded w-full bg-white" value={form.subId} onChange={e=>setForm({...form, subId:e.target.value})}>
                                        <option value="">Select Subject</option>{subjects.map(s=><option key={s.id} value={s.id}>{s.name}</option>)}
                                    </select>
                                </div>
                                <div className="md:col-span-3">
                                    <label className="text-xs font-bold text-gray-500 block mb-1">Primary Teacher</label>
                                    <select className="border p-2 rounded w-full bg-white" value={form.teachId} onChange={e=>setForm({...form, teachId:e.target.value})}>
                                        <option value="">Select Teacher</option>{faculty.map(f=><option key={f.id} value={f.id}>{f.name}</option>)}
                                    </select>
                                </div>
                                <div className="md:col-span-3">
                                    <div className="flex items-center gap-2 mb-1">
                                        <input type="checkbox" id="hasAsst" checked={form.hasAsst} onChange={e=>setForm({...form, hasAsst:e.target.checked})} className="accent-blue-600"/>
                                        <label htmlFor="hasAsst" className="text-xs font-bold text-gray-500 cursor-pointer">Assistant?</label>
                                    </div>
                                    <select className="border p-2 rounded w-full disabled:bg-gray-100 bg-white" disabled={!form.hasAsst} value={form.asstId} onChange={e=>setForm({...form, asstId:e.target.value})}>
                                        <option value="">-- None --</option>{faculty.filter(f=>f.id!=form.teachId).map(f=><option key={f.id} value={f.id}>{f.name}</option>)}
                                    </select>
                                </div>
                                <div className="md:col-span-1">
                                    <label className="text-xs font-bold text-gray-500 block mb-1">Hrs</label>
                                    <input type="number" min="1" max="10" className="border p-2 rounded w-full text-center" value={form.hours} onChange={e=>setForm({...form, hours:e.target.value})} />
                                </div>
                                <div className="md:col-span-2 flex gap-1">
                                    <button onClick={handleSubmit} className={`w-full text-white p-2 rounded h-[42px] font-medium transition-colors ${editId ? 'bg-orange-500 hover:bg-orange-600' : 'bg-green-600 hover:bg-green-700'}`}>
                                        {editId ? "Update" : "Add"}
                                    </button>
                                    {editId && <button onClick={()=>{setEditId(null); setForm({...form, subId:'', hours:1})}} className="bg-gray-200 text-gray-600 px-3 rounded hover:bg-gray-300">X</button>}
                                </div>
                            </div>
                        </div>

                        <div className="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                            <table className="w-full text-left text-sm">
                                <thead className="bg-gray-50 border-b text-gray-500 uppercase text-xs">
                                    <tr><th className="p-4">Subject</th><th className="p-4">Faculty</th><th className="p-4">Hrs</th><th className="p-4 text-right">Actions</th></tr>
                                </thead>
                                <tbody className="divide-y">
                                    {classWork.length === 0 ? <tr><td colSpan="4" className="p-8 text-center text-gray-400 italic">No workload assigned for this class yet.</td></tr> : classWork.map(w => {
                                        const s = subjects.find(x=>x.id===w.subjectId);
                                        const t = faculty.find(x=>x.id===w.teacherId);
                                        const a = faculty.find(x=>x.id===w.assistantId);
                                        return (
                                            <tr key={w.id} className={`transition-colors ${editId === w.id ? 'bg-orange-50' : 'hover:bg-gray-50'}`}>
                                                <td className="p-4 font-medium text-gray-900">{s?.name}</td>
                                                <td className="p-4">
                                                    <div className="flex items-center gap-2">
                                                        <span className="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs font-bold">{t?.short}</span>
                                                        {a && <span className="bg-cyan-100 text-cyan-700 px-2 py-1 rounded text-xs">+ {a?.short}</span>}
                                                    </div>
                                                </td>
                                                <td className="p-4 font-bold text-gray-600">{w.hoursPerWeek}</td>
                                                <td className="p-4 text-right">
                                                    <div className="flex justify-end gap-1">
                                                        <button onClick={()=>startEdit(w)} className="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded"><Icon name="pencil" className="w-4 h-4" /></button>
                                                        <button onClick={()=>setWorkload(workload.filter(x=>x.id!==w.id))} className="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded"><Icon name="trash-2" className="w-4 h-4" /></button>
                                                    </div>
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    </div>
                );
            };

            const ConstraintsTab = () => {
                return (
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div className="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                            <h3 className="text-lg font-bold mb-4 flex items-center gap-2 text-blue-800">
                                <Icon name="sliders" className="w-5 h-5"/> Generation Rules
                            </h3>
                            <div className="space-y-6">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Max Consecutive Hours</label>
                                    <div className="flex items-center gap-2">
                                        <input 
                                            type="number" 
                                            min="1" max="5" 
                                            value={constraints.maxConsecutive}
                                            onChange={e => setConstraints({...constraints, maxConsecutive: parseInt(e.target.value)})}
                                            className="border p-2 rounded w-24 text-center"
                                        />
                                        <span className="text-sm text-gray-500">hours before a forced break.</span>
                                    </div>
                                </div>
                                
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Max Daily Hours per Teacher</label>
                                    <div className="flex items-center gap-2">
                                        <input 
                                            type="number" 
                                            min="1" max="5" 
                                            value={constraints.maxDailyHours}
                                            onChange={e => setConstraints({...constraints, maxDailyHours: parseInt(e.target.value)})}
                                            className="border p-2 rounded w-24 text-center"
                                        />
                                        <span className="text-sm text-gray-500">total hours in a single day.</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="bg-blue-50 p-6 rounded-lg border border-blue-100">
                            <h3 className="text-lg font-bold mb-4 flex items-center gap-2 text-blue-800">
                                <Icon name="info" className="w-5 h-5"/> Logic Info
                            </h3>
                            <p className="text-sm text-blue-800 leading-relaxed">
                                The logic engine uses a backtracking algorithm. It respects "Hard Constraints" automatically:
                            </p>
                            <ul className="list-disc list-inside mt-3 space-y-2 text-sm text-blue-700">
                                <li>A teacher cannot be in two places at once.</li>
                                <li>A class cannot have two subjects at once.</li>
                                <li>Assistants must also be free during joint classes.</li>
                            </ul>
                        </div>
                    </div>
                );
            };

            const ResultsTab = () => {
                if(isGenerating) return <div className="h-96 flex flex-col items-center justify-center text-gray-500"><Icon name="refresh-cw" className="w-12 h-12 animate-spin mb-4 text-blue-500" /><h2 className="text-xl font-bold text-gray-800">Calculating...</h2><p>Finding the best slots for {workload.length} classes.</p></div>;
                if(generationError) return <div className="bg-red-50 p-10 text-center rounded-lg border border-red-100"><Icon name="alert-circle" className="w-12 h-12 text-red-500 mx-auto mb-4" /><h3 className="text-xl font-bold text-red-800 mb-2">Generation Failed</h3><p className="text-red-600 mb-6 max-w-md mx-auto">{generationError}</p><button onClick={()=>setActiveTab('workload')} className="bg-white border border-red-200 text-red-600 px-6 py-2 rounded-full font-medium hover:bg-red-50 transition-colors">Adjust Workload Matrix</button></div>;
                if(!finalSchedule) return <div className="text-center p-20 text-gray-400 bg-white rounded-lg border border-dashed"><Icon name="calendar" className="w-16 h-16 mx-auto mb-4 text-gray-200" /><p className="text-lg">Ready to Generate.</p><p className="text-sm">Click the button below to create the timetable.</p></div>;

                const days = ["Mon", "Tue", "Wed", "Thu", "Fri"];
                return (
                    <div className="space-y-12">
                        {classes.map(cls => (
                            <div key={cls.id} className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                                <div className="bg-slate-50 px-6 py-4 border-b flex justify-between items-center">
                                    <h3 className="text-lg font-bold text-slate-800">{cls.name}</h3>
                                    <span className="text-xs font-mono text-slate-400">{cls.short}</span>
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-center text-sm border-collapse">
                                        <thead>
                                            <tr>
                                                <th className="p-3 border-b border-r bg-slate-50 w-24 text-slate-500 uppercase text-xs tracking-wider">Day</th>
                                                {[1,2,3,4,5].map(p=><th key={p} className="p-3 border-b border-r bg-slate-50 text-slate-500 uppercase text-xs tracking-wider">Period {p}</th>)}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {days.map((day, dIdx) => (
                                                <tr key={day}>
                                                    <td className="p-4 border-b border-r font-bold text-slate-400 bg-slate-50/50">{day}</td>
                                                    {[1,2,3,4,5].map(p => {
                                                        const slot = finalSchedule[cls.id][dIdx][p];
                                                        if(!slot) return <td key={p} className="p-2 border-b border-r text-gray-200 bg-white hover:bg-gray-50 transition-colors">-</td>;
                                                        
                                                        const sub = subjects.find(x=>x.id===slot.subjectId);
                                                        const tea = faculty.find(x=>x.id===slot.teacherId);
                                                        const asst = faculty.find(x=>x.id===slot.assistantId);
                                                        
                                                        return (
                                                            <td key={p} className="p-2 border-b border-r bg-white hover:bg-blue-50 transition-colors relative group h-24 align-middle">
                                                                <div className="flex flex-col items-center gap-1">
                                                                    <div className="font-bold text-slate-800 leading-tight">{sub?.name}</div>
                                                                    <div className="text-[10px] text-slate-400">{sub?.code}</div>
                                                                    <div className="flex gap-1 mt-1">
                                                                        <span style={{backgroundColor: tea?.color}} className="px-2 py-0.5 rounded text-[10px] font-bold border border-black/5 shadow-sm">
                                                                            {tea?.short}
                                                                        </span>
                                                                        {asst && (
                                                                            <span style={{backgroundColor: asst?.color}} className="px-2 py-0.5 rounded text-[10px] font-bold border border-black/5 shadow-sm">
                                                                                {asst?.short}
                                                                            </span>
                                                                        )}
                                                                    </div>
                                                                </div>
                                                            </td>
                                                        );
                                                    })}
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        ))}
                    </div>
                );
            };

            return (
                <div className="min-h-screen pb-24">
                    {/* TOP BAR */}
                    <div className="bg-white border-b sticky top-0 z-20 px-4 h-16 flex items-center justify-between shadow-sm/50 backdrop-blur-md bg-white/90">
                        <div className="flex items-center gap-3">
                            <div className="bg-blue-600 text-white p-2 rounded-lg shadow-blue-200 shadow-lg">
                                <Icon name="calendar-clock" className="w-5 h-5" />
                            </div>
                            <h1 className="font-bold text-xl text-slate-800 tracking-tight hidden md:block">Timetable Architect</h1>
                        </div>
                        <div className="flex items-center gap-4">
                            <span className={`text-xs font-medium transition-opacity duration-300 ${saveStatus ? 'opacity-100 text-green-600' : 'opacity-0'}`}>
                                <Icon name="check-circle" className="w-3 h-3 inline mr-1"/> Auto-saved
                            </span>
                        </div>
                    </div>
                    
                    {/* TABS */}
                    <div className="bg-white border-b sticky top-16 z-10 shadow-sm">
                        <div className="max-w-6xl mx-auto px-4">
                            <div className="flex space-x-6 overflow-x-auto no-scrollbar">
                                {[
                                    {id:'faculty', icon:'users', label:'Faculty'},
                                    {id:'entities', icon:'layers', label:'Classes & Subjects'},
                                    {id:'workload', icon:'briefcase', label:'Workload Matrix'},
                                    {id:'constraints', icon:'settings', label:'Rules'},
                                    {id:'results', icon:'calendar-check', label:'Final Schedule'}
                                ].map(t => (
                                    <button 
                                        key={t.id} 
                                        onClick={()=>setActiveTab(t.id)} 
                                        className={`flex items-center gap-2 py-4 border-b-2 text-sm font-medium transition-all whitespace-nowrap ${activeTab===t.id ? 'border-blue-600 text-blue-600' : 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300'}`}
                                    >
                                        <Icon name={t.icon} className="w-4 h-4" />
                                        {t.label}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>

                    {/* MAIN CONTENT */}
                    <div className="max-w-6xl mx-auto p-4 md:p-8">
                        {activeTab === 'faculty' && <FacultyTab />}
                        {activeTab === 'entities' && <EntitiesTab />}
                        {activeTab === 'workload' && <WorkloadTab />}
                        {activeTab === 'constraints' && <ConstraintsTab />}
                        {activeTab === 'results' && <ResultsTab />}
                    </div>

                    {/* FAB */}
                    {activeTab !== 'results' && (
                        <button 
                            onClick={handleGenerate} 
                            className="fixed bottom-8 right-8 bg-blue-600 text-white px-6 py-4 rounded-full shadow-xl shadow-blue-600/30 font-bold flex items-center gap-2 hover:scale-105 transition-transform z-50"
                        >
                            <Icon name="play" className="w-5 h-5 fill-current" /> 
                            Generate Timetable
                        </button>
                    )}
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<TimetableApp />);
    </script>
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</body>
</html>
